import discord
from discord.ext import commands
import json
import logging
import re
from datetime import datetime
import pytz

logger = logging.getLogger('discord_bot.customization')

class Customization(commands.Cog):
    """Cog pour la personnalisation du bot"""
    
    def __init__(self, bot):
        self.bot = bot
        self.guild_settings = {}
        self.load_guild_settings()
    
    def load_guild_settings(self):
        """Charge les param√®tres des serveurs"""
        try:
            with open('guild_settings.json', 'r', encoding='utf-8') as f:
                self.guild_settings = json.load(f)
        except FileNotFoundError:
            self.guild_settings = {}
            logger.info("Fichier de param√®tres des serveurs cr√©√©")
    
    def save_guild_settings(self):
        """Sauvegarde les param√®tres des serveurs"""
        try:
            with open('guild_settings.json', 'w', encoding='utf-8') as f:
                json.dump(self.guild_settings, f, indent=2, ensure_ascii=False)
        except Exception as e:
            logger.error(f"Erreur lors de la sauvegarde des param√®tres: {e}")
    
    def get_guild_settings(self, guild_id):
        """R√©cup√®re les param√®tres d'un serveur"""
        guild_id = str(guild_id)
        if guild_id not in self.guild_settings:
            self.guild_settings[guild_id] = {
                'prefix': '!',
                'embed_color': '0x3498db',
                'language': 'fr',
                'timezone': 'Europe/Paris'
            }
        return self.guild_settings[guild_id]
    
    @commands.command(name='color')
    @commands.has_permissions(administrator=True)
    async def set_embed_color(self, ctx, color: str):
        """Change la couleur des embeds du bot"""
        # Validation de la couleur hexad√©cimale
        if not re.match(r'^#?[0-9A-Fa-f]{6}$', color):
            embed = discord.Embed(
                title="‚ùå Couleur invalide",
                description="Utilisez un code couleur hexad√©cimal valide (ex: #3498db ou 3498db)",
                color=0xe74c3c
            )
            await ctx.send(embed=embed)
            return
        
        # Normalisation de la couleur
        if not color.startswith('#'):
            color = '#' + color
        
        # Conversion en format 0x
        hex_color = '0x' + color[1:]
        
        # Mise √† jour des param√®tres
        guild_settings = self.get_guild_settings(ctx.guild.id)
        old_color = guild_settings['embed_color']
        guild_settings['embed_color'] = hex_color
        
        # Mise √† jour de la config globale du bot
        self.bot.config['embed_color'] = hex_color
        
        # Sauvegarde
        self.save_guild_settings()
        with open('config.json', 'w', encoding='utf-8') as f:
            json.dump(self.bot.config, f, indent=2, ensure_ascii=False)
        
        # D√©monstration avec la nouvelle couleur
        embed = discord.Embed(
            title="‚úÖ Couleur mise √† jour",
            description=f"La couleur des embeds a √©t√© chang√©e de `{old_color}` vers `{hex_color}`",
            color=int(hex_color, 16)
        )
        embed.add_field(name="Aper√ßu", value="Voici un aper√ßu de la nouvelle couleur !", inline=False)
        await ctx.send(embed=embed)
        logger.info(f"Couleur des embeds chang√©e pour {ctx.guild.name}: {old_color} -> {hex_color}")
    
    @commands.command(name='prefix')
    @commands.has_permissions(administrator=True)
    async def set_prefix(self, ctx, new_prefix: str):
        """Change le pr√©fixe des commandes du bot"""
        if len(new_prefix) > 5:
            embed = discord.Embed(
                title="‚ùå Pr√©fixe trop long",
                description="Le pr√©fixe ne peut pas d√©passer 5 caract√®res.",
                color=0xe74c3c
            )
            await ctx.send(embed=embed)
            return
        
        if ' ' in new_prefix:
            embed = discord.Embed(
                title="‚ùå Pr√©fixe invalide",
                description="Le pr√©fixe ne peut pas contenir d'espaces.",
                color=0xe74c3c
            )
            await ctx.send(embed=embed)
            return
        
        # Mise √† jour des param√®tres
        guild_settings = self.get_guild_settings(ctx.guild.id)
        old_prefix = guild_settings['prefix']
        guild_settings['prefix'] = new_prefix
        
        # Sauvegarde
        self.save_guild_settings()
        
        embed = discord.Embed(
            title="‚úÖ Pr√©fixe mis √† jour",
            description=f"Le pr√©fixe a √©t√© chang√© de `{old_prefix}` vers `{new_prefix}`",
            color=int(self.bot.config['embed_color'], 16)
        )
        embed.add_field(
            name="üí° Exemple d'utilisation",
            value=f"`{new_prefix}help` - Affiche l'aide\n`{new_prefix}ping` - Teste la latence",
            inline=False
        )
        embed.set_footer(text=f"Nouveau pr√©fixe: {new_prefix}")
        await ctx.send(embed=embed)
        logger.info(f"Pr√©fixe chang√© pour {ctx.guild.name}: {old_prefix} -> {new_prefix}")
    
    @commands.command(name='language')
    @commands.has_permissions(administrator=True)
    async def set_language(self, ctx, lang: str):
        """Change la langue du bot (fr/en)"""
        lang = lang.lower()
        if lang not in ['fr', 'en', 'fran√ßais', 'english', 'francais']:
            embed = discord.Embed(
                title="‚ùå Langue non support√©e",
                description="Langues disponibles : `fr` (fran√ßais), `en` (anglais)",
                color=0xe74c3c
            )
            await ctx.send(embed=embed)
            return
        
        # Normalisation
        if lang in ['fran√ßais', 'francais']:
            lang = 'fr'
        elif lang == 'english':
            lang = 'en'
        
        # Mise √† jour des param√®tres
        guild_settings = self.get_guild_settings(ctx.guild.id)
        old_lang = guild_settings['language']
        guild_settings['language'] = lang
        
        # Sauvegarde
        self.save_guild_settings()
        
        # Messages selon la langue
        if lang == 'fr':
            title = "‚úÖ Langue mise √† jour"
            description = f"La langue a √©t√© chang√©e de `{old_lang}` vers `{lang}` (Fran√ßais)"
            note = "Note : Cette fonctionnalit√© sera pleinement impl√©ment√©e dans une future mise √† jour."
        else:
            title = "‚úÖ Language Updated"
            description = f"Language changed from `{old_lang}` to `{lang}` (English)"
            note = "Note: This feature will be fully implemented in a future update."
        
        embed = discord.Embed(
            title=title,
            description=description,
            color=int(self.bot.config['embed_color'], 16)
        )
        embed.add_field(name="üìù Note", value=note, inline=False)
        await ctx.send(embed=embed)
        logger.info(f"Langue chang√©e pour {ctx.guild.name}: {old_lang} -> {lang}")
    
    @commands.command(name='timezone')
    @commands.has_permissions(administrator=True)
    async def set_timezone(self, ctx, *, timezone: str):
        """Change le fuseau horaire du serveur"""
        try:
            # V√©rification que le fuseau horaire existe
            tz = pytz.timezone(timezone)
            
            # Mise √† jour des param√®tres
            guild_settings = self.get_guild_settings(ctx.guild.id)
            old_timezone = guild_settings['timezone']
            guild_settings['timezone'] = timezone
            
            # Sauvegarde
            self.save_guild_settings()
            
            # Affichage de l'heure actuelle dans le nouveau fuseau
            now = datetime.now(tz)
            time_str = now.strftime("%H:%M:%S")
            date_str = now.strftime("%d/%m/%Y")
            
            embed = discord.Embed(
                title="‚úÖ Fuseau horaire mis √† jour",
                description=f"Le fuseau horaire a √©t√© chang√© de `{old_timezone}` vers `{timezone}`",
                color=int(self.bot.config['embed_color'], 16)
            )
            embed.add_field(name="üïê Heure actuelle", value=f"{time_str}", inline=True)
            embed.add_field(name="üìÖ Date actuelle", value=f"{date_str}", inline=True)
            embed.add_field(
                name="üí° Exemples de fuseaux",
                value="‚Ä¢ `Europe/Paris`\n‚Ä¢ `America/New_York`\n‚Ä¢ `Asia/Tokyo`\n‚Ä¢ `UTC`",
                inline=False
            )
            await ctx.send(embed=embed)
            logger.info(f"Fuseau horaire chang√© pour {ctx.guild.name}: {old_timezone} -> {timezone}")
            
        except pytz.exceptions.UnknownTimeZoneError:
            embed = discord.Embed(
                title="‚ùå Fuseau horaire invalide",
                description=f"Le fuseau horaire `{timezone}` n'existe pas.",
                color=0xe74c3c
            )
            embed.add_field(
                name="üí° Exemples valides",
                value="‚Ä¢ `Europe/Paris`\n‚Ä¢ `America/New_York`\n‚Ä¢ `Asia/Tokyo`\n‚Ä¢ `UTC`\n‚Ä¢ `Europe/London`",
                inline=False
            )
            embed.add_field(
                name="üîó Liste compl√®te",
                value="[Voir tous les fuseaux horaires](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones)",
                inline=False
            )
            await ctx.send(embed=embed)
    
    @commands.command(name='settings')
    @commands.has_permissions(administrator=True)
    async def show_settings(self, ctx):
        """Affiche les param√®tres actuels du serveur"""
        guild_settings = self.get_guild_settings(ctx.guild.id)
        
        # R√©cup√©ration de l'heure actuelle dans le fuseau du serveur
        try:
            tz = pytz.timezone(guild_settings['timezone'])
            now = datetime.now(tz)
            time_str = now.strftime("%H:%M:%S %d/%m/%Y")
        except:
            time_str = "Erreur de fuseau horaire"
        
        embed = discord.Embed(
            title="‚öôÔ∏è Param√®tres du Serveur",
            description=f"Configuration actuelle pour **{ctx.guild.name}**",
            color=int(guild_settings['embed_color'], 16)
        )
        
        embed.add_field(name="üé® Couleur des embeds", value=guild_settings['embed_color'], inline=True)
        embed.add_field(name="üìù Pr√©fixe", value=f"`{guild_settings['prefix']}`", inline=True)
        embed.add_field(name="üåç Langue", value=guild_settings['language'].upper(), inline=True)
        embed.add_field(name="üïê Fuseau horaire", value=guild_settings['timezone'], inline=True)
        embed.add_field(name="‚è∞ Heure locale", value=time_str, inline=True)
        embed.add_field(name="üÜî ID du serveur", value=ctx.guild.id, inline=True)
        
        embed.set_footer(text="Utilisez les commandes !color, !prefix, !language, !timezone pour modifier")
        await ctx.send(embed=embed)

async def setup(bot):
    await bot.add_cog(Customization(bot))
